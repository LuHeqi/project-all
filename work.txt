年终大奖获奖通知信息发送问题通报
业务目标
通过短信、邮件两种通道向年终大奖23000名获奖人员发送获奖通知信息。
问题现象描述
2020.1.2日早上9点半，方昆做例行巡检时发现IT负责阿里云平台短信服务账号异常，出现发送超预警线及可发送额度降为0。在RTX群里确认后，发现是年终大奖通知所致。经过排查发现邮件和短信都没有发送完全。具体数据描述如下：
	短信发送失败：14783，短信发送成功：8700
	邮件发送失败用户数：4942，邮件发送成功用户数：19105（有重复发送情况，根据邮件服务器的统计，有5万封邮件）
	发送重复（重复两条）短信通知成功：1294
	发送邮件重复（5封）：16
	发送邮件重复（4封）：13
	发送邮件重复（3封）：5289
	发送邮件重复（2封）：11069
12点，收到线下IT同事王绍的邮件，反馈因为年终大奖发送了5万封邮件导致世强的官邮被客户的邮件拦截系统拉入黑名单，导致业务人员发给部分客户的出货、订单等邮件对方无法收到。
根因分析
短信发送失败
	直接原因：IT管理的阿里云短信服务账号余额仅能支持不足1万条短信，而且该账号设置了短信日发送限量也是10000条，导致发送过程中出现欠费拒发问题。
	根本原因：在通知操作前，缺少必要自检及资源确认，导致资源不足。

官邮被拉黑及邮件发送失败
	直接原因：因为大量集中统一标题的邮件导致公司的官邮被客户拉入黑名单，从而导致线下业务邮件使用受阻，且部分获奖用户不能收到领奖通知邮件。
	根本原因：电商平台的海量邮件发送策略不统一，有的点因为出现过问题已经切换到专业的EDM服务商通道，但是没有对所有需要发送邮件的场景进行切换，导致没有和线下业务使用的邮件服务器进行隔离；缺少必要的邮件发送流控机制，容易被客户的官邮识别为垃圾邮件，从而进行邮件过滤或者更加严厉的拉黑措施。而且历史曾经出现过类似问题，但是因为IT组织分的太细，导致问题一个节点的问题仅在一个节点进行修复，而不是通盘考虑。

短信和邮件的重复发送
	直接原因：发奖通知使用定时任务发送机制，每十分钟扫描需要发送通知的用户，10分钟是根据设计容量8000个获奖用户而确定的，由于本次发送数据变成了2.3W， 10分钟之内没有办法发完所有，所以定时任务重新又发了还没有发送成功的，导致了重复发送。
	根本原因：严重的技术设计缺陷，首先就算是按照8000的设计容量设计的系统，也需要对超限场景进行考虑，可以给予告警或者强制中断业务，而不是不停重发；其次在重发过程中，也需要考虑历史数据的影响，而不是不加考虑的全量反复重发。没有将设计关键指标8000做成一个关键数据进行强调，当业务发生变更的时候，操作人员不知道系统的容量限制，导致了最终结果。
应急措施
	召开运营、产品和IT参与的紧急会议讨论应急措施和根本解决方案。计划完成时间：2020年1月2日。状态：已完成。
	针对短信发送失败的用户，通过热补丁工具进行补发，做的对每个获奖VIP用户成功发送通知短信。计划完成时间：2020年1月2日。状态：已完成。
	针对邮件发送失败的用户，由IT整理不同奖项的发送用户清单，由运营起草邮件发送模板，并通过EDM渠道补发邮件。计划完成时间：2020年1月3日。状态：进行中。
	针对官邮被拉黑的问题，线下IT团队在持续跟进，推动已知受限的两个客户进行放通，对其他客户的情况进行持续关注。状态：已知客户问题已经解封，其他客户持续关注。
	在根本解决方案没有落地前，暂时先关闭手动批量发送邮件、短信操作的相关功能，需要业务通过自己管理的短信平台、EDM平台批量发送操作。计划完成时间：2020年1月16日。状态：进行中。
	电商IT要把该问题做成典型案例，组织开发部门全员学习，提升开发人员的能力；并组织问题自检，杜绝同类型问题再次发生。计划完成时间：2020年1月16日。状态：进行中。
根本解决方案
	针对业务需求，在系统交付时，除了提供系统功能交付件，还需要提供关联资源的checklist，需要运营执行人员进行业务操作的时候Checklist进行自检。
	短信需要从业务上区分平台系统通知类短信和营销业务类短信，使用两个不同的短信账号，前者由IT管理，后者由运营管理，各自根据实际要求设置流量限制和制定费用预算；针对紧急场景也可以作为主从互备节点。
	电商平台的邮件通知需要全部切换到现在的EDM通道，同时，需要构建备份方案（引入其他供应商或者再开一个独立账号），增强系统的抗风险能力；有关限流策略，一方面需要构建电商平台的邮件发送限流策略，另一方面需要向EDM提出有关限流的明确要求，并把这个要求作为技术选型的重要标准。
	IT需要把短信、邮件等基础服务化，确保每个使用的业务节点都共享统一的流控策略，而不是现在问题会在不同的业务节点反复出现。
	设计约束必须在上面提到checklist中有所呈现，并通过测试用例让所有相关人知道并在交付前得到验证；关键设计方案必须组织内部评审，减少问题出现概率。
	线下IT要从最后关口对邮件发送做流控，特别是在线上还没有完全切换完成，需要基于不同的发送场景提供不同的流控策略。
